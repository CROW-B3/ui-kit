name: Cleanup PR Preview

on:
  pull_request:
    branches:
      - main
    types: [closed]

concurrency:
  group: pr-preview-cleanup-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  cleanup-preview:
    runs-on: blacksmith-2vcpu-ubuntu-2404-arm
    # Only run for PRs from the same repository, not forks
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Find preview versions to clean up
        id: versions
        run: |
          pr_number="${{ github.event.pull_request.number }}"
          echo "Finding all preview versions for PR #$pr_number"

          if versions=$(npm view @b3-crow/ui-kit versions --json 2>/dev/null); then
            preview_versions=$(echo "$versions" | jq -r --arg pr "-pr$pr_number." 'if . == null then [] else (if type == "array" then . else [.] end) end | .[] | select(contains($pr))' 2>/dev/null || echo "")

            if [ -z "$preview_versions" ]; then
              echo "No preview versions found for PR #$pr_number"
              echo "versions=" >> $GITHUB_OUTPUT
            else
              echo "Found preview versions:"
              echo "$preview_versions"
              echo "versions<<EOF" >> $GITHUB_OUTPUT
              echo "$preview_versions" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "Could not fetch package versions from npm"
            echo "versions=" >> $GITHUB_OUTPUT
          fi

      - name: Unpublish or deprecate preview versions
        run: |
          preview_versions="${{ steps.versions.outputs.versions }}"

          if [ -z "$preview_versions" ]; then
            echo "No preview versions to clean up"
            exit 0
          fi

          echo "$preview_versions" | while IFS= read -r preview_version; do
            if [ -z "$preview_version" ]; then
              continue
            fi

            version="@b3-crow/ui-kit@$preview_version"
            echo "Attempting to unpublish $version"

            if npm unpublish "$version" 2>/dev/null; then
              echo "Successfully unpublished $version"
            else
              echo "Unpublish failed - attempting to deprecate instead"
              if npm deprecate "$version" "This PR preview version is no longer needed and should not be used." 2>/dev/null; then
                echo "Successfully deprecated $version"
              else
                echo "Version may not exist or was already removed"
              fi
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Cleanup pr-preview tag if needed
        run: |
          if versions=$(npm view @b3-crow/ui-kit versions --json 2>/dev/null); then
            preview_count=$(echo "$versions" | jq 'if . == null then [] else (if type == "array" then . else [.] end) end | [.[] | select(contains("-pr"))] | length' 2>/dev/null || echo "0")

            if ! [[ "$preview_count" =~ ^[0-9]+$ ]]; then
              preview_count="0"
            fi
          else
            echo "Could not fetch package versions from npm"
            preview_count="0"
          fi

          echo "Remaining preview versions: $preview_count"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
