name: Cleanup PR Preview

on:
  pull_request:
    branches:
      - main
    types: [closed]

concurrency:
  group: pr-preview-cleanup-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  cleanup-preview:
    runs-on: blacksmith-2vcpu-ubuntu-2404-arm
    # Only run for PRs from the same repository, not forks
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Get preview version
        id: version
        run: |
          if [ ! -f "package.json" ]; then
            echo "package.json not found - skipping cleanup"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          current=$(jq -r '.version' package.json 2>/dev/null)

          if [ -z "$current" ] || [ "$current" = "null" ]; then
            echo "No version found in package.json - skipping cleanup"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Current version in package.json: $current"

          base_version=$(echo "$current" | sed 's/[-+].*$//')

          if [ -z "$base_version" ]; then
            echo "Could not extract base version - skipping cleanup"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          preview_version="${base_version}-pr${{ github.event.pull_request.number }}"
          echo "Preview version to delete: $preview_version"
          echo "version=$preview_version" >> $GITHUB_OUTPUT

      - name: Unpublish or deprecate preview version
        run: |
          preview_version="${{ steps.version.outputs.version }}"

          if [ -z "$preview_version" ]; then
            echo "No preview version to clean up - skipping"
            exit 0
          fi

          version="@b3-crow/ui-kit@$preview_version"
          echo "Attempting to unpublish $version"

          if npm unpublish "$version" 2>/dev/null; then
            echo "Successfully unpublished $version"
          else
            echo "Unpublish failed - attempting to deprecate instead"
            if npm deprecate "$version" "This PR preview version is no longer needed and should not be used." 2>/dev/null; then
              echo "Successfully deprecated $version"
            else
              echo "Version may not exist or was already removed"
            fi
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Cleanup pr-preview tag if needed
        run: |
          if versions=$(npm view @b3-crow/ui-kit versions --json 2>/dev/null); then
            preview_count=$(echo "$versions" | jq 'if . == null then [] else (if type == "array" then . else [.] end) end | [.[] | select(contains("-pr"))] | length' 2>/dev/null || echo "0")

            if ! [[ "$preview_count" =~ ^[0-9]+$ ]]; then
              preview_count="0"
            fi
          else
            echo "Could not fetch package versions from npm"
            preview_count="0"
          fi

          echo "Remaining preview versions: $preview_count"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
